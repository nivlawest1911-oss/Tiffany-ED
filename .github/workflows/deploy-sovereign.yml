# EdIntel Sovereign - Multimodal Live Avatar Deployment
# Vercel + Google Cloud + GitHub Architecture

name: Deploy EdIntel Sovereign

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  CLOUD_RUN_SERVICE: edintel-avatar-engine
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ============================================
  # BUILD & TEST
  # ============================================
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Linter
        run: npm run lint

      - name: Build Application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}

      - name: Run Tests
        run: npm test --if-present

  # ============================================
  # DEPLOY TO VERCEL (Presentation Layer)
  # ============================================
  deploy-vercel:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Vercel Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Production
        id: vercel-deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployed to: $DEPLOYMENT_URL"

      - name: Comment Deployment URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ **Vercel Preview Deployed**: ${{ steps.vercel-deploy.outputs.deployment_url }}'
            })

  # ============================================
  # DEPLOY TO GOOGLE CLOUD (Cognitive Layer)
  # Using Workload Identity Federation (Keyless)
  # ============================================
  deploy-gcp:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    
    # Grant permissions for OIDC token
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (Workload Identity Federation)
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}
          token_format: 'access_token'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build Avatar Engine Docker Image
        run: |
          docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE }}:${{ github.sha }} \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE }}:latest \
            -f cloud/Dockerfile.avatar .

      - name: Push to Google Container Registry
        run: |
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE }}:${{ github.sha }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --timeout 300 \
            --concurrency 80 \
            --min-instances 1 \
            --max-instances 10 \
            --set-env-vars "VERTEX_AI_PROJECT=${{ env.GCP_PROJECT_ID }}" \
            --set-env-vars "VERTEX_AI_LOCATION=${{ env.GCP_REGION }}" \
            --set-secrets "DATABASE_URL=DATABASE_URL:latest" \
            --set-secrets "GOOGLE_GENERATIVE_AI_API_KEY=GOOGLE_GENERATIVE_AI_API_KEY:latest"

      - name: Get Cloud Run URL
        id: cloud-run-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Cloud Run Service: $SERVICE_URL"
      
      - name: Log Deployment Audit Trail
        run: |
          echo "üîê Deployment authenticated via Workload Identity Federation"
          echo "üë§ GitHub Actor: ${{ github.actor }}"
          echo "üì¶ Repository: ${{ github.repository }}"
          echo "üîñ Commit SHA: ${{ github.sha }}"
          echo "‚è∞ Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

  # ============================================
  # DATABASE MIGRATION (Cloud SQL)
  # ============================================
  migrate-database:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Run Prisma Migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Generate Prisma Client
        run: npx prisma generate

  # ============================================
  # PERFORMANCE & SECURITY CHECKS
  # ============================================
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # ============================================
  # NOTIFY DEPLOYMENT STATUS
  # ============================================
  notify-deployment:
    needs: [deploy-vercel, deploy-gcp, migrate-database]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send Deployment Notification
        run: |
          echo "üéØ EdIntel Sovereign Deployment Complete"
          echo "üì¶ Vercel: Production"
          echo "‚òÅÔ∏è Google Cloud: ${{ env.CLOUD_RUN_SERVICE }}"
          echo "üóÑÔ∏è Database: Migrated"
